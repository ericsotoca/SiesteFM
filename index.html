<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sieste FM - La Radio qui vous endort en douceur.</title>
    <link rel="preload" href="logo.png" as="image">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
<!-- Ajouter une police Google -->
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap" rel="stylesheet">
   
    <style>
        /* --- AJOUT GOOGLE FONTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Nunito:wght@400;700&display=swap');

        /* --- START OF COMBINED CSS --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }


        body {
            background-color: #0D1B2A;
            color: #ffffff;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            font-family: 'Nunito', sans-serif; /* Police principale */
			font-family: 'Lora', serif; /* Utiliser la police douce */
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            width: 100%;
        }
		.soft-text {
			font-size: 1.2em;
			color: #ffffff; /* Texte blanc */
			font-style: italic; /* Texte en italique */
			margin: 20px 0; /* Ajoute de l'espace au-dessus et en dessous du texte */
			padding: 10px;  /* Ajoute de l'espace à l'intérieur du texte */
			line-height: 1.6; /* Ajuste l'espacement entre les lignes */
			background-color: rgba(255, 255, 255, 0.1); /* Fond légèrement transparent pour un effet subtil */
			border-radius: 8px; /* Coins arrondis pour un look plus doux */
			display: inline-block; /* Pour que le fond s'adapte à la taille du texte */
		}

        .logo {
            height: auto;
            display: block;
            margin-left: auto;
            margin-right: auto;
            max-height: 150px;
            max-width: 100%;
        }

        .loading-message {
            text-align: center;
            padding: 60px 20px;
            font-style: italic;
            color: #aaa;
            min-height: 240px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Nunito', sans-serif; /* Assurez-vous que le message de chargement utilise Nunito */
        }

        .iframe-container {
            width: 100%;
            margin-bottom: 20px;
            background-color: #1C2C3A;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            min-height: 240px;
            position: relative;
        }

        #suno-iframe {
            display: block;
            border: none;
            width: 100%;
            height: 240px;
            transition: opacity 0.3s ease;
        }

        .button-next {
            display: inline-block;
            background-color: #5c67f2;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 10;
            font-family: 'Nunito', sans-serif; /* Bouton suivant */
        }

        .button-next:hover {
            background-color: #4a54cc;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
        }

        .button-next:focus {
            outline: 2px solid #5c67f2;
            outline-offset: 2px;
        }

        .button-next:disabled {
            background-color: #4a54cc;
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .intro-support-text {
            text-align: center;
            margin-bottom: 30px;
            color: #ccc;
            line-height: 1.7;
            font-size: 0.95em;
            padding: 0 10px;
            font-family: 'Nunito', sans-serif; /* Texte introductif */
        }

        .support-section {
            text-align: center;
            margin: 40px 0;
            padding: 20px;
            background-color: rgba(92, 103, 242, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(92, 103, 242, 0.3);
        }

        .support-title {
            font-family: 'Caveat', cursive; /* Titre de soutien */
            font-size: 2.2em;
            font-weight: 700;
            color: #707aff;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .support-text {
            margin-bottom: 20px;
            line-height: 1.6;
            color: #ccc;
            font-size: 1em;
            font-family: 'Nunito', sans-serif; /* Texte de soutien */
        }

        .support-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .support-button {
            display: inline-block;
            background-color: #f28c31;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
            font-family: 'Nunito', sans-serif; /* Boutons de soutien */
        }

        .support-button.paypal-button {
            background-color: #0070ba;
        }

        .support-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .support-button.paypal-button:hover {
            box-shadow: 0 4px 8px rgba(0, 112, 186, 0.4);
        }

        .support-button:not(.paypal-button):hover {
            box-shadow: 0 4px 8px rgba(242, 140, 49, 0.4);
        }

        #now-playing {
            display: none;
        }

        /* --- START OF nap-timer CSS --- */
        #nap-duration-selector-area {
            margin-bottom: 20px;
            text-align: center;
            padding: 15px;
            background-color: rgba(28, 44, 58, 0.7);
            border-radius: 8px;
        }

        #nap-buttons-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .duration-button {
            padding: 8px 15px;
            border: 1px solid #5c67f2;
            border-radius: 20px;
            background-color: transparent;
            color: #c5c5c5;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            font-size: 0.9em;
            font-family: 'Nunito', sans-serif; /* Boutons de durée */
        }

        .duration-button:hover {
            background-color: rgba(92, 103, 242, 0.2);
            color: #ffffff;
        }

        .duration-button.active {
            background-color: #5c67f2;
            color: white;
            border-color: #5c67f2;
        }

        .duration-button.active:hover {
            background-color: #5c67f2;
            color: white;
        }

        #cancel-nap-timer {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            background-color: #f44336;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
            margin-left: 10px;
            vertical-align: middle;
            font-family: 'Nunito', sans-serif; /* Bouton annuler minuteur */
        }

        #cancel-nap-timer:hover {
            background-color: #d32f2f;
        }

        #cancel-nap-timer.hidden {
            display: none;
        }

        #nap-timer-display {
            margin-top: 10px;
            font-size: 1.1em;
            font-weight: bold;
            color: #a5f3fc;
            min-height: 1.2em;
            display: inline-block;
            vertical-align: middle;
        }

        #nap-timer-display.hidden {
            display: none;
        }
        /* --- END OF nap-timer CSS --- */

        /* --- START OF Overlay styles --- */
        #initial-play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            background-color: rgba(13, 27, 42, 0.9);
            border-radius: 8px;
            cursor: pointer;
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
            z-index: 20;
            visibility: visible;
            opacity: 1;
        }

        #initial-play-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        #start-radio-button {
            background-color: #5c67f2;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            font-family: 'Nunito', sans-serif; /* Bouton démarrer radio */
        }

        #start-radio-button:hover {
            background-color: #4a54cc;
            transform: scale(1.05);
        }

        #start-radio-button:focus {
            outline: 2px solid #5c67f2;
            outline-offset: 2px;
        }

        .overlay-icon {
            font-size: 3em;
            color: #5c67f2;
            margin-bottom: 10px;
            animation: pulse 2s infinite ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .overlay-text {
            font-size: 0.9em;
            color: #ccc;
            margin-top: 15px;
            font-family: 'Nunito', sans-serif; /* Texte de l'overlay */
        }
        /* --- END OF Overlay styles --- */

        /* --- START OF Preloader styles --- */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0D1B2A;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
            visibility: visible;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #5c67f2;
            border-top: 4px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        #preloader p {
            color: #aaa;
            font-family: 'Nunito', sans-serif; /* Texte du préchargeur */
        }

        #preloader.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* --- END OF Preloader styles --- */

        /* --- START OF Responsive styles --- */
        @media (max-width: 600px) {
            body { padding: 10px; }
            header { padding: 15px 0; margin-bottom: 20px; }
            .logo { width: 100%; max-width: 100%; height: auto; max-height: none; margin-left: 0; margin-right: 0; }
            #start-radio-button { padding: 12px 24px; font-size: 1em; }
            .overlay-icon { font-size: 2.5em; }
            .button-next { padding: 8px 16px; font-size: 0.8em; bottom: 8px; right: 8px; }
            .intro-support-text { margin-bottom: 20px; font-size: 0.9em; }
            .support-section { padding: 15px; margin: 25px 0; }
            .support-title { font-size: 1.9em; margin-bottom: 15px; }
            .support-buttons { gap: 10px; }
            .support-button { padding: 8px 16px; font-size: 0.9em; }
            .iframe-container { margin-bottom: 10px; }
            #nap-duration-selector-area { padding: 10px; margin-bottom: 15px; }
            #nap-buttons-container { gap: 8px; }
            .duration-button { padding: 6px 12px; font-size: 0.85em; }
            #cancel-nap-timer { padding: 6px 12px; font-size: 0.85em; }
            #nap-timer-display { font-size: 1em; margin-top: 8px; }
        }
        /* --- END OF Responsive styles --- */
    </style>
</head>
<body>
    <div id="preloader">
        <div class="spinner"></div>
        <p>Chargement de Sieste FM...</p> <!-- Hérite Nunito -->
    </div>

    <header>
        <img src="logo.png" alt="Sieste FM" class="logo">
    </header>

    <!-- Zone pour le sélecteur de durée de sieste (avec boutons) -->
    <div id="nap-duration-selector-area">
        <div id="nap-buttons-container">
            <button class="duration-button" data-duration="10">10 min</button>
            <button class="duration-button" data-duration="15">15 min</button>
            <button class="duration-button" data-duration="30">30 min</button>
            <button class="duration-button active" data-duration="0">Illimité</button>
        </div>
        <div>
            <div id="nap-timer-display" class="hidden"></div>
            <button id="cancel-nap-timer" class="hidden">Annuler Minuteur</button>
        </div>
    </div>

    <div class="iframe-container" id="player-container">
        <div id="initial-play-overlay">
            <span class="overlay-icon" aria-hidden="true">🎵</span>
            <button id="start-radio-button">Lancer Sieste FM</button>
        </div>
        <div id="iframe-target">
            <div class="loading-message" id="iframe-loading-placeholder">Chargement du lecteur...</div> <!-- Style italic, mais police Nunito -->
        </div>
        <button id="next-track" class="button-next">Morceau Suivant ⏭️</button>
    </div>

    <!-- DIV #now-playing EST MAINTENANT CACHÉE PAR CSS -->
    <div id="now-playing">
        <p id="now-playing-text"></p> <!-- Hériterait Nunito si visible -->
    </div>

    <!-- --- PARAGRAPHE INTRODUCTIF --- -->
    <p class="soft-text">
        Chez Sieste FM, nos ondes sont sans pub pour une sieste paisible. Nous croyons que la musique et les ronronnements sont un droit. Votre soutien crée des moments de bonheur... et notre chat mascotte vous remercie! 
    </p>

    <div class="support-section">
        <h2 class="support-title">SOUTENIR Sieste FM</h2> <!-- Police Caveat -->

        <div class="support-buttons">
            <a href="https://www.paypal.com/donate/?hosted_button_id=S8GPJPJYS79WS" target="_blank" class="support-button paypal-button">Faire un don via PayPal</a> <!-- Police Nunito -->
            <a href="https://fr.tipeee.com/SiesteFM/" target="_blank" class="support-button">Nous soutenir sur Tipeee</a> <!-- Police Nunito -->
        </div>
        <p class="support-title"><BR>Merci</p> <!-- Police Nunito -->
    </div>

    <script>
        // --- START OF COMBINED JAVASCRIPT ---

        // Liste complète des pistes
        const sunoTracks = [
            { "id": "1be45c7f-efee-4288-bb46-24bc4ac633a6", "title": "A Walk in the Park", "artist": "Suno AI", "categorie": "Calme Puissant", "duration": 131 },
            { "id": "25a32452-1bfd-4791-b378-7584a0be64f5", "title": "Aerial Awakening", "artist": "Zneip.", "categorie": "Calme Puissant", "duration": 214 },
            { "id": "afd7cad2-6112-4670-9274-378468a1c59d", "title": "After the rain", "artist": "RareRecordLabels1439", "categorie": "Calme Puissant", "duration": 239 },
            { "id": "3a09ffcc-f677-42ad-9ec0-dd2e01b7adca", "title": "Aurora Dance (Instrumental)", "artist": "Xian - ExclusiveKnob421", "categorie": "Calme Puissant", "duration": 140 },
            { "id": "533b9834-52a5-4100-8d05-9ef605a4e715", "title": "Blues in the light of dawn", "artist": "GROOVEBOT.", "categorie": "Calme Puissant", "duration": 183 },
            { "id": "16555cd3-3aab-4f6d-b02c-8c15ebf6a8f1", "title": "Cade la neve", "artist": "Jazz56", "categorie": "Calme Puissant", "duration": 240 },
            { "id": "d012de10-e877-43f1-92f4-9bd2e706f52d", "title": "🎶 Darlin', Don't You Go 🎶", "artist": "RetroDream.", "categorie": "Calme Puissant", "duration": 206 },
            { "id": "e48c0ee8-24c8-459b-8d91-469dbd6fc3a5", "title": "Dialectic (accept it)", "artist": "yolkhead", "categorie": "Calme Puissant", "duration": 239 },
            { "id": "a3e445c8-b7e6-4f11-9c5c-2e7281c8a68e", "title": "Ethereal Journey", "artist": "GROOVEBOT.", "categorie": "Calme Puissant", "duration": 160 },
            { "id": "b4661e87-97c3-4b6e-87ca-f31f47ac40ef", "title": "Eu Não Ando Sumido", "artist": "Roberto na Área.", "categorie": "Calme Puissant", "duration": 168 },
            { "id": "2160a428-d7c4-4892-b250-9a739a60e475", "title": "Fuja de quem não quer te perder mas não sabe te amar", "artist": "Roberto na Área.", "categorie": "Calme Puissant", "duration": 157 },
            { "id": "176e197f-0656-4351-9516-1ebc05d4855f", "title": "Her First Heartbreak", "artist": "Brandon Luke.", "categorie": "Calme Puissant", "duration": 185 },
            { "id": "3899e808-d76f-48d4-b850-3ab3c6da6a88", "title": "Island Breeze", "artist": "DrollFire383.", "categorie": "Calme Puissant", "duration": 240 },
            { "id": "75b62359-9b3e-4ffe-839b-0eb7c11de71e", "title": "Let's Take a Chance", "artist": "MyDreamSongs.", "categorie": "Calme Puissant", "duration": 213 },
            { "id": "b50869d5-fd45-4219-987b-22d68621178e", "title": "Love and Peace", "artist": "Vibe Music Ai Records.", "categorie": "Calme Puissant", "duration": 194 },
            { "id": "9d601e01-1282-4a76-afb5-b710edc38f8f", "title": "Onde cristalline de sérénité", "artist": "JeanMiK2.", "categorie": "Calme Puissant", "duration": 144 },
            { "id": "aa0febaa-6c8b-444b-a34f-db5155272b2b", "title": "Peaceful Meadow", "artist": "Suno AI", "categorie": "Calme Puissant", "duration": 152 },
            { "id": "72fd52d4-bb7e-48aa-a5e3-0115540c5a62", "title": "Pulse Beneath the Waves", "artist": "Sotoca AI.", "categorie": "Calme Puissant", "duration": 240 },
            { "id": "d4cd5909-e7cc-4751-a6e1-f7a28f44808a", "title": "Reflections in Solitude", "artist": "Henryhan", "categorie": "Calme Puissant", "duration": 179 },
            { "id": "b9d4abb4-1df8-40c5-952c-10e72f16df54", "title": "Sunrise Symphony", "artist": "Suno AI", "categorie": "Calme Puissant", "duration": 198 },
            { "id": "60035e3c-4024-4438-a0bf-85bea5b5fcd3", "title": "Well Well Well", "artist": "Vibe Music Ai Records.", "categorie": "Calme Puissant", "duration": 223 },
            { "id": "e1917ac3-d715-457a-b17c-e21982141a53", "title": "🇷🇺Mellstroy Плаки плаки", "artist": "Wondarlove", "categorie": "Calme Puissant", "duration": 164 }
        ];

        // Variables globales
        let currentTrackId = null;
        let nextTrackTimer = null;
        let radioHasStarted = false;
        let isLoading = false;
        let nextTrackPreload = null;
        let napTimerInterval = null;
        let napEndTime = null;

        // Éléments du DOM
        const preloader = document.getElementById('preloader');
        const playerContainer = document.getElementById('player-container');
        const initialOverlay = document.getElementById('initial-play-overlay');
        const startButton = document.getElementById('start-radio-button');
        const iframeTarget = document.getElementById('iframe-target');
        const nextTrackButton = document.getElementById('next-track');
        const loadingPlaceholder = document.getElementById('iframe-loading-placeholder');
        let napButtonsContainer = null;
        let timerDisplay = null;
        let cancelNapButton = null;

        function preloadNextTrack() {
            nextTrackPreload = selectRandomTrack();
        }

        function stopRadioPlayback() {
            const iframe = document.getElementById('suno-iframe');
            if (iframe) { iframe.remove(); }
            if (loadingPlaceholder) {
                if (!iframeTarget.contains(loadingPlaceholder)) { iframeTarget.innerHTML = ''; iframeTarget.appendChild(loadingPlaceholder); }
                loadingPlaceholder.style.display = 'flex';
                loadingPlaceholder.textContent = "Minuteur terminé. Radio arrêtée.";
            } else { iframeTarget.innerHTML = '<p class="loading-message">Minuteur terminé. Radio arrêtée.</p>'; }
            if (nextTrackTimer) clearTimeout(nextTrackTimer);
            nextTrackTimer = null;
            radioHasStarted = false;
            currentTrackId = null;
            nextTrackPreload = null;
            isLoading = false;
            if (initialOverlay) { initialOverlay.classList.remove('hidden'); }
            if (nextTrackButton) { nextTrackButton.disabled = true; }
        }

        function getPlayHistory() {
            try { return JSON.parse(localStorage.getItem('sunoRadioHistory')) || []; }
            catch (e) { console.error("Err hist:", e); return []; }
        }

        function updatePlayHistory(trackId) {
            if (!trackId) return;
            let history = getPlayHistory();
            const track = sunoTracks.find(t => t.id === trackId);
            if (track) {
                if (history.length === 0 || history[0].id !== trackId) {
                    history.unshift({ id: trackId, title: track.title, artist: track.artist, timestamp: new Date().toISOString() });
                    if (history.length > 15) history = history.slice(0, 15);
                    try { localStorage.setItem('sunoRadioHistory', JSON.stringify(history)); }
                    catch (e) { console.error("Err save hist:", e); }
                }
            }
        }

        function selectRandomTrack() {
            const history = getPlayHistory();
            let availableTracks = [...sunoTracks];
            if (availableTracks.length === 0) return null;
            const historyDepthToExclude = Math.min(5, availableTracks.length - 1);
            const tracksToExclude = [];
            if (currentTrackId) tracksToExclude.push(currentTrackId);
            for (let i = 0; i < historyDepthToExclude && i < history.length; i++) { tracksToExclude.push(history[i].id); }
            const uniqueExclusions = [...new Set(tracksToExclude)];
            let filteredTracks = availableTracks.filter(track => !uniqueExclusions.includes(track.id));
            if (filteredTracks.length === 0 && availableTracks.length > 0) {
                const lastPlayedId = history.length > 0 ? history[0].id : null;
                filteredTracks = availableTracks.filter(track => track.id !== currentTrackId && track.id !== lastPlayedId);
                if (filteredTracks.length === 0) filteredTracks = availableTracks;
            } else if (filteredTracks.length === 0) { return null; }
            return filteredTracks[Math.floor(Math.random() * filteredTracks.length)];
        }

        function updateProgress(track) {
            if (track && track.duration && track.duration > 0) {
                const durationMs = track.duration * 1000;
                if (nextTrackTimer) clearTimeout(nextTrackTimer);
                nextTrackTimer = setTimeout(() => { loadNextTrack(); }, durationMs);
            } else {
                if (nextTrackTimer) clearTimeout(nextTrackTimer);
                nextTrackTimer = null;
            }
        }

        function loadTrack(track) {
            if (!track || !track.id) { setTimeout(loadNextTrack, 3000); return; }
            if (nextTrackTimer) clearTimeout(nextTrackTimer);
            currentTrackId = track.id;
            isLoading = true;
            iframeTarget.innerHTML = `<p class="loading-message" id="iframe-loading-placeholder">Chargement de "${track.title}"...</p>`;

            const iframe = document.createElement('iframe');
            iframe.id = 'suno-iframe';
            iframe.src = `https://suno.com/embed/${track.id}?autoplay=true`;
            iframe.title = `Lecteur Suno pour ${track.title}`;
            iframe.allow = 'autoplay';
            iframe.loading = 'eager';
            iframe.sandbox = "allow-scripts allow-same-origin allow-presentation";
            iframe.style.opacity = '0';

            iframe.onload = () => {
                isLoading = false;
                const placeholder = document.getElementById('iframe-loading-placeholder');
                if(placeholder) placeholder.remove();
                iframe.style.opacity = '1';
                updatePlayHistory(track.id);
                updateProgress(track);
                preloadNextTrack();
            };
            iframe.onerror = (e) => {
                iframeTarget.innerHTML = `<p class="loading-message" id="iframe-loading-placeholder">Erreur chargement: "${track.title}". Suivant...</p>`;
                isLoading = false;
                if (nextTrackTimer) clearTimeout(nextTrackTimer);
                currentTrackId = null;
                setTimeout(loadNextTrack, 5000);
            };

            const currentPlaceholder = document.getElementById('iframe-loading-placeholder');
            if (currentPlaceholder) currentPlaceholder.remove();
            iframeTarget.appendChild(iframe);
        }

        function loadNextTrack() {
            if (isLoading || !radioHasStarted) { return; }
            isLoading = true;
            iframeTarget.innerHTML = '<p class="loading-message" id="iframe-loading-placeholder">Chargement...</p>';
            if (nextTrackTimer) clearTimeout(nextTrackTimer);
            currentTrackId = null;
            setTimeout(() => {
                const trackToLoad = nextTrackPreload || selectRandomTrack();
                nextTrackPreload = null;
                if (trackToLoad) {
                    loadTrack(trackToLoad);
                } else {
                    iframeTarget.innerHTML = '<p class="loading-message" id="iframe-loading-placeholder">Erreur : Aucun morceau.</p>';
                    isLoading = false;
                }
            }, 150);
        }

        function startRadioFirstTime() {
            if (radioHasStarted) return;
            try { const audioContext = new (window.AudioContext || window.webkitAudioContext)(); if (audioContext.state === 'suspended') { audioContext.resume(); } } catch (e) { console.warn("AudioCtx fail:", e); }
            radioHasStarted = true;
            initialOverlay.classList.add('hidden');
            if(nextTrackButton) nextTrackButton.disabled = false;
            preloadNextTrack();
            loadNextTrack();
        }

        function formatTime(seconds) {
            if (seconds < 0) seconds = 0;
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            let timeString = '';
            if (h > 0) timeString += `${h}h `;
            if (m > 0 || h > 0) timeString += `${m.toString().padStart(h > 0 ? 2 : 1, '0')}m `;
            timeString += `${s.toString().padStart(2, '0')}s`;
            return timeString.trim();
        }

        function resetNapTimerUI() {
            const durationButtons = napButtonsContainer.querySelectorAll('.duration-button');
            durationButtons.forEach(btn => btn.classList.remove('active'));
            const unlimitedButton = napButtonsContainer.querySelector('.duration-button[data-duration="0"]');
            if (unlimitedButton) unlimitedButton.classList.add('active');
            if (timerDisplay) timerDisplay.classList.add('hidden');
            if (cancelNapButton) cancelNapButton.classList.add('hidden');
        }

        function updateTimerDisplay() {
            if (!napEndTime || !timerDisplay || !cancelNapButton) return;
            const now = Date.now();
            const remainingSeconds = Math.round((napEndTime - now) / 1000);
            if (remainingSeconds <= 0) {
                clearInterval(napTimerInterval);
                napTimerInterval = null;
                napEndTime = null;
                timerDisplay.textContent = "Fin de la sieste !";
                timerDisplay.classList.remove('hidden');
                cancelNapButton.classList.add('hidden');
                if (typeof stopRadioPlayback === 'function') { stopRadioPlayback(); }
                resetNapTimerUI();
                setTimeout(() => {
                    if (!napTimerInterval) { timerDisplay.classList.add('hidden'); }
                }, 5000);
            } else {
                timerDisplay.textContent = `Temps restant : ${formatTime(remainingSeconds)}`;
                timerDisplay.classList.remove('hidden');
                cancelNapButton.classList.remove('hidden');
            }
        }

        function startNapTimer(durationMinutes) {
            if (napTimerInterval) clearInterval(napTimerInterval);
            if (durationMinutes > 0) {
                const durationMillis = durationMinutes * 60 * 1000;
                napEndTime = Date.now() + durationMillis;
                updateTimerDisplay();
                napTimerInterval = setInterval(updateTimerDisplay, 1000);
                if (cancelNapButton) cancelNapButton.classList.remove('hidden');
                if (timerDisplay) timerDisplay.classList.remove('hidden');
                if (!radioHasStarted && typeof startRadioFirstTime === 'function') { startRadioFirstTime(); }
            } else {
                napEndTime = null;
                resetNapTimerUI();
            }
        }

        function cancelNapTimer() {
            if (napTimerInterval) clearInterval(napTimerInterval);
            napTimerInterval = null;
            napEndTime = null;
            if (timerDisplay) {
                timerDisplay.textContent = "Minuteur annulé.";
                timerDisplay.classList.remove('hidden');
                setTimeout(() => { timerDisplay.classList.add('hidden'); }, 2000);
            }
            resetNapTimerUI();
        }

        function initializeNapTimerUI() {
            napButtonsContainer = document.getElementById('nap-buttons-container');
            timerDisplay = document.getElementById('nap-timer-display');
            cancelNapButton = document.getElementById('cancel-nap-timer');
            if (!napButtonsContainer || !timerDisplay || !cancelNapButton) { return; }
            napButtonsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('duration-button')) {
                    const duration = parseInt(event.target.dataset.duration, 10);
                    napButtonsContainer.querySelectorAll('.duration-button').forEach(btn => btn.classList.remove('active'));
                    event.target.classList.add('active');
                    startNapTimer(duration);
                }
            });
            cancelNapButton.addEventListener('click', cancelNapTimer);
            resetNapTimerUI();
        }

        function setupEventListeners() {
            startButton.addEventListener('click', (event) => { event.stopPropagation(); startRadioFirstTime(); });
            nextTrackButton.addEventListener('click', () => { if (isLoading) return; if (!radioHasStarted) { startRadioFirstTime(); } else { loadNextTrack(); } });
            window.addEventListener('offline', () => {
                if (nextTrackTimer) clearTimeout(nextTrackTimer);
                const currentIframe = document.getElementById('suno-iframe');
                if (currentIframe) {
                    currentIframe.style.display = 'none';
                    if (!document.getElementById('offline-placeholder')) { /* Add offline message */ }
                }
                if(nextTrackButton) nextTrackButton.disabled = true;
            });
            window.addEventListener('online', () => {
                if(nextTrackButton) nextTrackButton.disabled = false;
                const offlineMsg = document.getElementById('offline-placeholder');
                if (offlineMsg) offlineMsg.remove();
                const currentIframe = document.getElementById('suno-iframe');
                if (currentIframe) currentIframe.style.display = 'block';
                if (radioHasStarted) { loadNextTrack(); }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!sunoTracks || sunoTracks.length === 0) {
                const overlayContent = document.getElementById('initial-play-overlay');
                if(overlayContent) { overlayContent.innerHTML = '<p class="loading-message" style="color: red;">Erreur: Liste morceaux vide!</p>'; }
                else { document.body.innerHTML = '<p style="color: red; text-align: center; padding: 50px;">Erreur: Liste morceaux vide!</p>'; }
                if (preloader) preloader.classList.add('hidden');
                return;
            }
            initializeNapTimerUI();
            setupEventListeners();
            if (preloader) preloader.classList.add('hidden');
            if(nextTrackButton) nextTrackButton.disabled = true;
        });

        // --- END OF COMBINED JAVASCRIPT ---
    </script>

    <script>
        // --- Service Worker Registration Script ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('SW registered: ', registration.scope);
                }, err => {
                    console.log('SW registration failed: ', err);
                });
            });
        }
        // --- End of Service Worker Registration Script ---
    </script>

</body>
</html>
