<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sieste FM - La Radio qui vous endort en douceur.</title>
    <link rel="preload" href="logo.png" as="image">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <!-- Ajouter une police Google -->
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- AJOUT GOOGLE FONTS --- */
        @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Nunito:wght@400;700&display=swap');

        /* --- START OF COMBINED CSS --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }


        body {
            background-color: #0D1B2A;
            color: #ffffff;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            font-family: 'Nunito', sans-serif; /* Police principale */
			font-family: 'Lora', serif; /* Utiliser la police douce */
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            width: 100%;
        }
		.soft-text {
			font-size: 1.2em;
			color: #ffffff; /* Texte blanc */
			font-style: italic; /* Texte en italique */
			margin: 20px 0; /* Ajoute de l'espace au-dessus et en dessous du texte */
			padding: 10px;  /* Ajoute de l'espace à l'intérieur du texte */
			line-height: 1.6; /* Ajuste l'espacement entre les lignes */
			background-color: rgba(255, 255, 255, 0.1); /* Fond légèrement transparent pour un effet subtil */
			border-radius: 8px; /* Coins arrondis pour un look plus doux */
			display: inline-block; /* Pour que le fond s'adapte à la taille du texte */
		}

        .logo {
            height: auto;
            display: block;
            margin-left: auto;
            margin-right: auto;
            max-height: 150px;
            max-width: 100%;
        }

        .loading-message {
            text-align: center;
            padding: 60px 20px;
            font-style: italic;
            color: #aaa;
            min-height: 240px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Nunito', sans-serif; /* Assurez-vous que le message de chargement utilise Nunito */
        }

        .iframe-container {
            width: 100%;
            margin-bottom: 20px;
            background-color: #1C2C3A;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
            min-height: 240px;
            position: relative;
        }

        #suno-iframe {
            display: block;
            border: none;
            width: 100%;
            height: 240px;
            transition: opacity 0.3s ease;
        }

        .button-next {
            display: inline-block;
            background-color: #5c67f2;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 10;
            font-family: 'Nunito', sans-serif; /* Bouton suivant */
        }

        .button-next:hover {
            background-color: #4a54cc;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
        }

        .button-next:focus {
            outline: 2px solid #5c67f2;
            outline-offset: 2px;
        }

        .button-next:disabled {
            background-color: #4a54cc;
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .intro-support-text {
            text-align: center;
            margin-bottom: 30px;
            color: #ccc;
            line-height: 1.7;
            font-size: 0.95em;
            padding: 0 10px;
            font-family: 'Nunito', sans-serif; /* Texte introductif */
        }

        .support-section {
            text-align: center;
            margin: 40px 0;
            padding: 20px;
            background-color: rgba(92, 103, 242, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(92, 103, 242, 0.3);
        }

        .support-title {
            font-family: 'Caveat', cursive; /* Titre de soutien */
            font-size: 2.2em;
            font-weight: 700;
            color: #707aff;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .support-text {
            margin-bottom: 20px;
            line-height: 1.6;
            color: #ccc;
            font-size: 1em;
            font-family: 'Nunito', sans-serif; /* Texte de soutien */
        }

        .support-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .support-button {
            display: inline-block;
            background-color: #f28c31;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
            font-family: 'Nunito', sans-serif; /* Boutons de soutien */
        }

        .support-button.paypal-button {
            background-color: #0070ba;
        }

        .support-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .support-button.paypal-button:hover {
            box-shadow: 0 4px 8px rgba(0, 112, 186, 0.4);
        }

        .support-button:not(.paypal-button):hover {
            box-shadow: 0 4px 8px rgba(242, 140, 49, 0.4);
        }

        #now-playing {
            display: none;
        }

        /* --- START OF nap-timer CSS --- */
        #nap-duration-selector-area {
            margin-bottom: 20px;
            text-align: center;
            padding: 15px;
            background-color: rgba(28, 44, 58, 0.7);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #nap-buttons-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .duration-button {
            padding: 8px 15px;
            border: 1px solid #5c67f2;
            border-radius: 20px;
            background-color: transparent;
            color: #c5c5c5;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            font-size: 0.9em;
            font-family: 'Nunito', sans-serif; /* Boutons de durée */
        }

        .duration-button:hover {
            background-color: rgba(92, 103, 242, 0.2);
            color: #ffffff;
        }

        .duration-button.active {
            background-color: #5c67f2;
            color: white;
            border-color: #5c67f2;
        }

        .duration-button.active:hover {
            background-color: #5c67f2;
            color: white;
        }

        #alarm-settings {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            color: #c5c5c5; /* Couleur similaire aux boutons non actifs */
            font-size: 0.9em;
        }

        #alarm-settings label {
            cursor: pointer;
            margin-right: 5px;
        }

        #enable-alarm {
            margin-left: 5px;
            vertical-align: middle;
            cursor: pointer;
            /* Style pour améliorer l'apparence de la checkbox */
            accent-color: #5c67f2; /* Couleur lorsque cochée */
        }

        #cancel-nap-timer {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            background-color: #f44336;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
            margin-left: 10px;
            vertical-align: middle;
            font-family: 'Nunito', sans-serif; /* Bouton annuler minuteur */
        }

        #cancel-nap-timer:hover {
            background-color: #d32f2f;
        }

        #cancel-nap-timer.hidden {
            display: none;
        }

        #nap-timer-display {
            margin-top: 10px;
            font-size: 1.1em;
            font-weight: bold;
            color: #a5f3fc;
            min-height: 1.2em;
            display: inline-block;
            vertical-align: middle;
        }

        #nap-timer-display.hidden {
            display: none;
        }
        /* --- END OF nap-timer CSS --- */

        /* --- START OF Overlay styles --- */
        #initial-play-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            background-color: rgba(13, 27, 42, 0.9);
            border-radius: 8px;
            cursor: pointer;
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out;
            z-index: 20;
            visibility: visible;
            opacity: 1;
        }

        #initial-play-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        #start-radio-button {
            background-color: #5c67f2;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            font-family: 'Nunito', sans-serif; /* Bouton démarrer radio */
        }

        #start-radio-button:hover {
            background-color: #4a54cc;
            transform: scale(1.05);
        }

        #start-radio-button:focus {
            outline: 2px solid #5c67f2;
            outline-offset: 2px;
        }

        .overlay-icon {
            font-size: 3em;
            color: #5c67f2;
            margin-bottom: 10px;
            animation: pulse 2s infinite ease-in-out;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .overlay-text {
            font-size: 0.9em;
            color: #ccc;
            margin-top: 15px;
            font-family: 'Nunito', sans-serif; /* Texte de l'overlay */
        }
        /* --- END OF Overlay styles --- */

        /* --- START OF Preloader styles --- */
        #preloader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0D1B2A;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 1;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
            visibility: visible;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #5c67f2;
            border-top: 4px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        #preloader p {
            color: #aaa;
            font-family: 'Nunito', sans-serif; /* Texte du préchargeur */
        }

        #preloader.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* --- END OF Preloader styles --- */

        /* --- START OF Responsive styles --- */
        @media (max-width: 600px) {
            body { padding: 10px; }
            header { padding: 15px 0; margin-bottom: 20px; }
            .logo { width: 100%; max-width: 100%; height: auto; max-height: none; margin-left: 0; margin-right: 0; }
            #start-radio-button { padding: 12px 24px; font-size: 1em; }
            .overlay-icon { font-size: 2.5em; }
            .button-next { padding: 8px 16px; font-size: 0.8em; bottom: 8px; right: 8px; }
            .intro-support-text { margin-bottom: 20px; font-size: 0.9em; }
            .support-section { padding: 15px; margin: 25px 0; }
            .support-title { font-size: 1.9em; margin-bottom: 15px; }
            .support-buttons { gap: 10px; }
            .support-button { padding: 8px 16px; font-size: 0.9em; }
            .iframe-container { margin-bottom: 10px; }
            #nap-duration-selector-area { padding: 10px; margin-bottom: 15px; display: flex; flex-direction: column; align-items: center; }
            #nap-buttons-container { gap: 8px; }
            .duration-button { padding: 6px 12px; font-size: 0.85em; }
            #alarm-settings { margin-top: 5px; font-size: 0.9em; }
            #cancel-nap-timer { padding: 6px 12px; font-size: 0.85em; }
            #nap-timer-display { font-size: 1em; margin-top: 8px; }
        }
        /* --- END OF Responsive styles --- */
    </style>
</head>
<body>
    <div id="preloader">
        <div class="spinner"></div>
        <p>Chargement de Sieste FM...</p> <!-- Hérite Nunito -->
    </div>

    <header>
        <img src="logo.png" alt="Sieste FM" class="logo">
    </header>

    <!-- Zone pour le sélecteur de durée de sieste (avec boutons) -->
    <div id="nap-duration-selector-area">
        <div id="nap-buttons-container">
            <button class="duration-button" data-duration="10">10 min</button>
            <button class="duration-button" data-duration="15">15 min</button>
            <button class="duration-button" data-duration="30">30 min</button>
            <button class="duration-button active" data-duration="0">Illimité</button>
        </div>
        <div id="alarm-settings">
            <label for="enable-alarm">Alarme musicale :</label>
            <input type="checkbox" id="enable-alarm">
        </div>
        <div>
            <div id="nap-timer-display" class="hidden"></div>
            <button id="cancel-nap-timer" class="hidden">Annuler Minuteur</button>
        </div>
    </div>

    <div class="iframe-container" id="player-container">
        <div id="initial-play-overlay">
            <span class="overlay-icon" aria-hidden="true">🎵</span>
            <button id="start-radio-button">Lancer Sieste FM</button>
        </div>
        <div id="iframe-target">
            <div class="loading-message" id="iframe-loading-placeholder">Chargement du lecteur...</div> <!-- Style italic, mais police Nunito -->
        </div>
        <button id="next-track" class="button-next">Morceau Suivant ⏭️</button>
    </div>

    <!-- DIV #now-playing EST MAINTENANT CACHÉE PAR CSS -->
    <div id="now-playing">
        <p id="now-playing-text"></p> <!-- Hériterait Nunito si visible -->
    </div>

    <div>
        <img src="merci.png" alt="Merci" class="logo">
    </div>

    <!-- --- PARAGRAPHE INTRODUCTIF --- -->
    <p class="soft-text">
        Chez Sieste FM, nos ondes sont sans pub pour une sieste paisible. Nous croyons que la musique et les ronronnements sont un droit. Votre soutien crée des moments de bonheur... et notre chat mascotte vous remercie!
    </p>

    <div class="support-section">
        <h2 class="support-title">SOUTENIR Sieste FM</h2> <!-- Police Caveat -->

        <div class="support-buttons">
            <a href="https://www.paypal.com/donate/?hosted_button_id=S8GPJPJYS79WS" target="_blank" class="support-button paypal-button">Faire un don via PayPal</a> <!-- Police Nunito -->
            <a href="https://fr.tipeee.com/sieste-fm/" target="_blank" class="support-button">Nous soutenir sur Tipeee</a> <!-- Police Nunito -->
        </div>
        <p class="support-title"><BR>Merci</p> <!-- Police Nunito -->
    </div>

    <script>
        // --- START OF COMBINED JAVASCRIPT ---

        // Liste complète des pistes de la radio
        const sunoTracks = [
            { "id": "25a32452-1bfd-4791-b378-7584a0be64f5", "title": "OK - Aerial Awakening", "artist": "Zneip.", "categorie": "Calme Puissant", "duration": 214 },
            { "id": "afd7cad2-6112-4670-9274-378468a1c59d", "title": "OK - After the rain", "artist": "RareRecordLabels1439", "categorie": "Calme Puissant", "duration": 239 },
            { "id": "3a09ffcc-f677-42ad-9ec0-dd2e01b7adca", "title": "OK - Aurora Dance (Instrumental)", "artist": "Xian - ExclusiveKnob421", "categorie": "Calme Puissant", "duration": 140 },
            { "id": "533b9834-52a5-4100-8d05-9ef605a4e715", "title": "OK - Blues in the light of dawn", "artist": "GROOVEBOT.", "categorie": "Calme Puissant", "duration": 183 },
            { "id": "d012de10-e877-43f1-92f4-9bd2e706f52d", "title": "OK - 🎶 Darlin', Don't You Go 🎶", "artist": "RetroDream.", "categorie": "Calme Puissant", "duration": 206 },
            { "id": "b4661e87-97c3-4b6e-87ca-f31f47ac40ef", "title": "OK - Eu Não Ando Sumido", "artist": "Roberto na Área.", "categorie": "Calme Puissant", "duration": 168 },
            { "id": "2160a428-d7c4-4892-b250-9a739a60e475", "title": "OK - Fuja de quem não quer te perder mas não sabe te amar", "artist": "Roberto na Área.", "categorie": "Calme Puissant", "duration": 157 },
            { "id": "176e197f-0656-4351-9516-1ebc05d4855f", "title": "OK - Her First Heartbreak", "artist": "Brandon Luke.", "categorie": "Calme Puissant", "duration": 185 },
            { "id": "75b62359-9b3e-4ffe-839b-0eb7c11de71e", "title": "OK - Let's Take a Chance", "artist": "MyDreamSongs.", "categorie": "Calme Puissant", "duration": 213 },
            { "id": "b50869d5-fd45-4219-987b-22d68621178e", "title": "OK - Love and Peace", "artist": "Vibe Music Ai Records.", "categorie": "Calme Puissant", "duration": 194 },
            { "id": "9d601e01-1282-4a76-afb5-b710edc38f8f", "title": "OK - Onde cristalline de sérénité", "artist": "JeanMiK2.", "categorie": "Calme Puissant", "duration": 144 },
            { "id": "72fd52d4-bb7e-48aa-a5e3-0115540c5a62", "title": "OK - Pulse Beneath the Waves", "artist": "Sotoca AI.", "categorie": "Calme Puissant", "duration": 240 },
            { "id": "d4cd5909-e7cc-4751-a6e1-f7a28f44808a", "title": "OK - Reflections in Solitude", "artist": "Henryhan", "categorie": "Calme Puissant", "duration": 179 },
            { "id": "78c49d2c-8774-416b-8470-04742f2883a4", "title": "Bed time Sleep", "artist": "TrippyFrequency282", "categorie": "Calme Puissant", "duration": 125 },
            { "id": "7c45cfb8-97ee-4b51-a283-092845a52702", "title": "Whispering Pines (Remastered)", "artist": "Chillkid", "categorie": "Calme Puissant", "duration": 239 },
            { "id": "04495919-1e20-4838-8e7e-132abffe6a68", "title": "Ниагара", "artist": "✨ IGRASVET ✨", "categorie": "Horizon Infini", "duration": 240 },
            { "id": "f57d4e70-2914-4f18-8d1b-604447713720", "title": "Nature sound", "artist": "SimpleGregorianChant623", "categorie": "Calme Puissant", "duration": 110 },
            { "id": "68389b8a-8243-492b-8c03-0223da676ca4", "title": "Forest", "artist": "SuguMix", "categorie": "Calme Puissant", "duration": 189 },
            { "id": "4015d568-f966-42f4-ab0a-804e07eadc08", "title": "My Nature (Instrumental Music)", "artist": "PISIAI89", "categorie": "Calme Puissant", "duration": 240 },
            { "id": "30062c06-78b0-4dd7-baad-aba28a3dadba", "title": "In the Woods", "artist": "Music-Mellow", "categorie": "Calme Puissant", "duration": 358 },
            { "id": "c3e9d24c-2ea4-4708-a484-f069ae500c10", "title": "BGM for Deep Relaxation", "artist": "Jun_（BGM）", "categorie": "Calme Puissant", "duration": 442 },
            { "id": "b20e9c62-b2dc-47ce-b417-c5580f88e5b1", "title": "Untitled", "artist": "GalvanizingBrainwaves286", "categorie": "Esprit Aiguisé", "duration": 240 },
            { "id": "ccfee604-1c76-407e-bb76-7b8d774758b0", "title": "Chirp, Chirp", "artist": "Golden ai Music", "categorie": "Esprit Aiguisé", "duration": 240 },
            { "id": "3ed6ebd3-97e6-45a0-ace8-3b133006d6cf", "title": "Mind refresh", "artist": "AstoundedLowPassFilters152", "categorie": "Calme Puissant", "duration": 120 },
            { "id": "bb5ee7ea-2ea7-461b-9652-c4e645a69d40", "title": "Zen music", "artist": "成神之路\u0026青春永驻@youtubeyu7", "categorie": "Calme Puissant", "duration": 240 },
            { "id": "2705f6c2-c1a8-49aa-8d9e-c3a3f528b9a4", "title": "24th form of Tai Chi", "artist": "Frosty_0013", "categorie": "Calme Puissant", "duration": 296 },
            { "id": "9ac11789-b51b-4b96-9107-cf1f3a39a015", "title": "Yoga melody", "artist": "AksharA", "categorie": "Calme Puissant", "duration": 240 },
            { "id": "d52624e6-abd4-4ed9-9fd1-6d73a9a8ba71", "title": "Calm down", "artist": "Motivation is key to success", "categorie": "Calme Puissant", "duration": 102 },
            { "id": "1915fe8e-8ec4-4f7f-919d-cf45f1ab0dff", "title": "Nothing To Say. #baghzaf", "artist": "🎅🤖🎸 Univers Vibes  @AI-VideoMusic🎄", "categorie": "Calme Puissant", "duration": 138 },
            { "id": "60cbe1bc-b483-4a33-a29b-3d767b36debf", "title": "🌇𝓢𝓾𝓷𝓼𝓮𝓽🌇", "artist": "RayanAIR™", "categorie": "Calme Puissant", "duration": 120 },
            { "id": "17762f8c-cea4-494b-8821-8eec567b0f64", "title": "Calm of the Moment", "artist": "E/V 🦇 ǝɹı̣dɯɐꓥ ɔı̣uoɹʇɔǝןƎ 🦇", "categorie": "Calme Puissant", "duration": 240 },
            { "id": "61fdeb18-e249-4127-b245-18eb875a7a4f", "title": "Sleep Ambient", "artist": "☀️ claire ☀️", "categorie": "Calme Puissant", "duration": 240 },
            { "id": "39b4776c-cb1c-4b9b-85c5-a1738a4a5b90", "title": "Resonating Hearts", "artist": "BreatheByMaytrixofficial2415", "categorie": "Calme Puissant", "duration": 240 },
            { "id": "2cfbe37c-f99d-4b04-ae0c-3be6af1cc1a5", "title": "Majestic Harp", "artist": "Compguy321 👨‍💻", "categorie": "Calme Puissant", "duration": 222 }
        ];

        // Informations sur la musique d'alarme
        const alarmTrackInfo = { "id": "948b8276-6714-460f-b526-033354e094ce", "title": "Cancer", "artist": "Joy'elle", "categorie": "Alarme", "duration": 157 };
        const alarmMusicPath = `https://suno.com/embed/${alarmTrackInfo.id}?autoplay=true`; // Utilisation de l'embed Suno comme demandé

        // Variables globales
        let currentTrackId = null;
        let nextTrackTimer = null;
        let radioHasStarted = false;
        let isLoading = false;
        let nextTrackPreload = null;
        let napTimerInterval = null;
        let napEndTime = null;
        let isAlarmEnabled = false;
        let alarmAudioPlayer = null; // Pour stocker l'iframe de l'alarme

        // Éléments du DOM
        const preloader = document.getElementById('preloader');
        const playerContainer = document.getElementById('player-container');
        const initialOverlay = document.getElementById('initial-play-overlay');
        const startButton = document.getElementById('start-radio-button');
        const iframeTarget = document.getElementById('iframe-target');
        const nextTrackButton = document.getElementById('next-track');
        const loadingPlaceholder = document.getElementById('iframe-loading-placeholder');
        let napButtonsContainer = null;
        let timerDisplay = null;
        let cancelNapButton = null;
        let enableAlarmCheckbox = null; // Référence à la checkbox

        function preloadNextTrack() {
            nextTrackPreload = selectRandomTrack();
        }

        function stopRadioPlayback() {
            const iframe = document.getElementById('suno-iframe');
            if (iframe) { iframe.remove(); }
            if (loadingPlaceholder) {
                if (!iframeTarget.contains(loadingPlaceholder)) { iframeTarget.innerHTML = ''; iframeTarget.appendChild(loadingPlaceholder); }
                loadingPlaceholder.style.display = 'flex';
                loadingPlaceholder.textContent = "Minuteur terminé. Radio arrêtée.";
            } else { iframeTarget.innerHTML = '<p class="loading-message">Minuteur terminé. Radio arrêtée.</p>'; }
            if (nextTrackTimer) clearTimeout(nextTrackTimer);
            nextTrackTimer = null;
            radioHasStarted = false;
            currentTrackId = null;
            nextTrackPreload = null;
            isLoading = false;
            if (initialOverlay) { initialOverlay.classList.remove('hidden'); }
            if (nextTrackButton) { nextTrackButton.disabled = true; }
            // Pas besoin d'appeler stopAlarm() ici, car updateTimerDisplay le fera si nécessaire
        }

        function getPlayHistory() {
            try { return JSON.parse(localStorage.getItem('sunoRadioHistory')) || []; }
            catch (e) { console.error("Erreur lecture historique:", e); return []; }
        }

        function updatePlayHistory(trackId) {
            if (!trackId) return;
            let history = getPlayHistory();
            const track = sunoTracks.find(t => t.id === trackId);
            if (track) {
                // Ajouter seulement si différent du dernier morceau joué
                if (history.length === 0 || (history.length > 0 && history[0].id !== trackId)) {
                    history.unshift({ id: trackId, title: track.title, artist: track.artist, timestamp: new Date().toISOString() });
                    if (history.length > 15) history = history.slice(0, 15); // Limiter l'historique
                    try { localStorage.setItem('sunoRadioHistory', JSON.stringify(history)); }
                    catch (e) { console.error("Erreur sauvegarde historique:", e); }
                }
            }
        }

        function selectRandomTrack() {
            const history = getPlayHistory();
            let availableTracks = [...sunoTracks];
            if (availableTracks.length === 0) return null;

            const historyDepthToExclude = Math.min(5, availableTracks.length - 1); // Exclure les 5 derniers joués (si possible)
            const tracksToExclude = [];
            if (currentTrackId) tracksToExclude.push(currentTrackId); // Exclure le morceau actuel
            for (let i = 0; i < historyDepthToExclude && i < history.length; i++) {
                tracksToExclude.push(history[i].id);
            }

            const uniqueExclusions = [...new Set(tracksToExclude)]; // IDs uniques à exclure

            let filteredTracks = availableTracks.filter(track => !uniqueExclusions.includes(track.id));

            // Si tous les morceaux ont été exclus (peu probable avec 15 max),
            // autoriser la relecture sauf le dernier joué et l'actuel
            if (filteredTracks.length === 0 && availableTracks.length > 0) {
                const lastPlayedId = history.length > 0 ? history[0].id : null;
                filteredTracks = availableTracks.filter(track => track.id !== currentTrackId && track.id !== lastPlayedId);
                if (filteredTracks.length === 0) filteredTracks = availableTracks; // Fallback: choisir n'importe lequel
            } else if (filteredTracks.length === 0) {
                 return null; // Aucune piste disponible
            }

            // Sélection aléatoire parmi les pistes filtrées
            return filteredTracks[Math.floor(Math.random() * filteredTracks.length)];
        }

        function updateProgress(track) {
            if (track && track.duration && track.duration > 0) {
                const durationMs = track.duration * 1000;
                if (nextTrackTimer) clearTimeout(nextTrackTimer);
                nextTrackTimer = setTimeout(() => { loadNextTrack(); }, durationMs);
            } else {
                console.warn(`Durée invalide pour ${track?.title}, passage au suivant dans 30s`);
                if (nextTrackTimer) clearTimeout(nextTrackTimer);
                nextTrackTimer = setTimeout(() => { loadNextTrack(); }, 30000); // Fallback
            }
        }

        function loadTrack(track) {
            if (!track || !track.id) {
                console.error("Tentative de chargement d'une piste invalide.");
                setTimeout(loadNextTrack, 3000); // Essayer la suivante
                return;
            }
            if (nextTrackTimer) clearTimeout(nextTrackTimer);
            currentTrackId = track.id;
            isLoading = true;
            iframeTarget.innerHTML = `<p class="loading-message" id="iframe-loading-placeholder">Chargement de "${track.title}"...</p>`;

            const iframe = document.createElement('iframe');
            iframe.id = 'suno-iframe';
            iframe.src = `https://suno.com/embed/${track.id}?autoplay=true`;
            iframe.title = `Lecteur Suno pour ${track.title}`;
            iframe.allow = 'autoplay';
            iframe.loading = 'eager';
            iframe.sandbox = "allow-scripts allow-same-origin allow-presentation";
            iframe.style.opacity = '0';

            iframe.onload = () => {
                isLoading = false;
                const placeholder = document.getElementById('iframe-loading-placeholder');
                if(placeholder) placeholder.remove();
                iframe.style.opacity = '1';
                updatePlayHistory(track.id);
                updateProgress(track);
                preloadNextTrack();
            };
            iframe.onerror = (e) => {
                console.error(`Erreur chargement iframe pour ${track.title}:`, e);
                iframeTarget.innerHTML = `<p class="loading-message" id="iframe-loading-placeholder">Erreur chargement: "${track.title}". Suivant...</p>`;
                isLoading = false;
                if (nextTrackTimer) clearTimeout(nextTrackTimer);
                currentTrackId = null;
                setTimeout(loadNextTrack, 5000); // Attendre avant de réessayer
            };

            // Nettoyer l'ancien contenu avant d'ajouter le nouveau
            iframeTarget.innerHTML = '';
            iframeTarget.appendChild(iframe);
        }

        function loadNextTrack() {
            if (isLoading || !radioHasStarted) { return; }
            isLoading = true;
            iframeTarget.innerHTML = '<p class="loading-message" id="iframe-loading-placeholder">Chargement...</p>';
            if (nextTrackTimer) clearTimeout(nextTrackTimer);
            currentTrackId = null;

            // Utiliser un petit délai pour laisser l'UI se mettre à jour
            setTimeout(() => {
                const trackToLoad = nextTrackPreload || selectRandomTrack();
                nextTrackPreload = null; // Utiliser la piste préchargée
                if (trackToLoad) {
                    loadTrack(trackToLoad);
                } else {
                    console.error("Impossible de sélectionner une nouvelle piste.");
                    iframeTarget.innerHTML = '<p class="loading-message" id="iframe-loading-placeholder">Erreur : Aucun morceau disponible.</p>';
                    isLoading = false;
                }
            }, 150);
        }

        function startRadioFirstTime() {
            if (radioHasStarted) return;
            // Tentative de déblocage du contexte audio (important pour l'autoplay)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        console.log("AudioContext resumed successfully.");
                    }).catch(e => console.error("AudioContext resume failed:", e));
                }
            } catch (e) {
                console.warn("AudioContext not supported or failed to initialize:", e);
            }
            radioHasStarted = true;
            initialOverlay.classList.add('hidden');
            if(nextTrackButton) nextTrackButton.disabled = false;
            preloadNextTrack();
            loadNextTrack();
        }

        function formatTime(seconds) {
            if (seconds < 0) seconds = 0;
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            let timeString = '';
            if (h > 0) timeString += `${h}h `;
            if (m > 0 || h > 0) timeString += `${m.toString().padStart(h > 0 ? 2 : 1, '0')}m `;
            timeString += `${s.toString().padStart(2, '0')}s`;
            return timeString.trim();
        }

        function resetNapTimerUI() {
            const durationButtons = napButtonsContainer?.querySelectorAll('.duration-button');
            durationButtons?.forEach(btn => btn.classList.remove('active'));
            // Activer "Illimité" par défaut
            const unlimitedButton = napButtonsContainer?.querySelector('.duration-button[data-duration="0"]');
            if (unlimitedButton) unlimitedButton.classList.add('active');
            if (timerDisplay) timerDisplay.classList.add('hidden');
            if (cancelNapButton) cancelNapButton.classList.add('hidden');
        }

        // Fonction pour jouer l'alarme
        function playAlarm() {
            stopAlarm(); // Arrêter l'alarme précédente si elle existe
            console.log("Playing alarm...");
            alarmAudioPlayer = document.createElement('iframe');
            alarmAudioPlayer.id = 'alarm-iframe';
            alarmAudioPlayer.src = alarmMusicPath;
            alarmAudioPlayer.allow = 'autoplay';
            alarmAudioPlayer.style.display = 'none'; // Cacher l'iframe
            alarmAudioPlayer.onerror = (e) => {
                console.error("Erreur chargement iframe alarme:", e);
                // Afficher un message d'erreur à l'utilisateur ?
            };
            document.body.appendChild(alarmAudioPlayer);
        }

        // Fonction pour arrêter l'alarme
        function stopAlarm() {
            if (alarmAudioPlayer) {
                console.log("Stopping alarm.");
                alarmAudioPlayer.remove();
                alarmAudioPlayer = null;
            }
        }

        function updateTimerDisplay() {
            if (!napEndTime || !timerDisplay || !cancelNapButton) return;
            const now = Date.now();
            const remainingSeconds = Math.round((napEndTime - now) / 1000);

            if (remainingSeconds <= 0) {
                clearInterval(napTimerInterval);
                napTimerInterval = null;
                napEndTime = null;

                timerDisplay.textContent = "Fin de la sieste !";
                timerDisplay.classList.remove('hidden');
                cancelNapButton.classList.add('hidden');

                // Arrêter la radio d'abord
                if (typeof stopRadioPlayback === 'function') { stopRadioPlayback(); }

                // Jouer l'alarme si activée
                if (isAlarmEnabled) {
                    playAlarm();
                }

                resetNapTimerUI();

                // Cacher le message et arrêter l'alarme après un délai
                setTimeout(() => {
                    if (!napTimerInterval && timerDisplay) { // Vérifier si un autre timer n'a pas été lancé entre temps
                         timerDisplay.classList.add('hidden');
                         stopAlarm();
                    }
                }, 15000); // Laisser l'alarme sonner pendant 15 secondes
            } else {
                timerDisplay.textContent = `Temps restant : ${formatTime(remainingSeconds)}`;
                timerDisplay.classList.remove('hidden');
                cancelNapButton.classList.remove('hidden');
            }
        }

        function startNapTimer(durationMinutes) {
            stopAlarm(); // Arrêter l'alarme si elle jouait
            if (napTimerInterval) clearInterval(napTimerInterval);

            if (durationMinutes > 0) {
                const durationMillis = durationMinutes * 60 * 1000;
                napEndTime = Date.now() + durationMillis;
                updateTimerDisplay(); // Afficher immédiatement
                napTimerInterval = setInterval(updateTimerDisplay, 1000);
                if (cancelNapButton) cancelNapButton.classList.remove('hidden');
                if (timerDisplay) timerDisplay.classList.remove('hidden');

                // Démarrer la radio si elle n'est pas déjà lancée et qu'un timer est actif
                if (!radioHasStarted && typeof startRadioFirstTime === 'function') {
                    startRadioFirstTime();
                }
            } else { // Cas "Illimité"
                napEndTime = null;
                resetNapTimerUI();
                // Démarrer la radio si ce n'est pas déjà fait
                if (!radioHasStarted && typeof startRadioFirstTime === 'function') {
                    startRadioFirstTime();
                }
            }
        }

        function cancelNapTimer() {
            if (napTimerInterval) clearInterval(napTimerInterval);
            napTimerInterval = null;
            napEndTime = null;
            if (timerDisplay) {
                timerDisplay.textContent = "Minuteur annulé.";
                timerDisplay.classList.remove('hidden');
                setTimeout(() => {
                    if (!napTimerInterval) { // Seulement si pas redémarré
                         timerDisplay.classList.add('hidden');
                    }
                }, 2000);
            }
            resetNapTimerUI();
            stopAlarm(); // Arrêter l'alarme si elle jouait
        }

        function initializeNapTimerUI() {
            napButtonsContainer = document.getElementById('nap-buttons-container');
            timerDisplay = document.getElementById('nap-timer-display');
            cancelNapButton = document.getElementById('cancel-nap-timer');
            enableAlarmCheckbox = document.getElementById('enable-alarm'); // Récupérer la checkbox

            if (!napButtonsContainer || !timerDisplay || !cancelNapButton || !enableAlarmCheckbox) {
                console.error("Un ou plusieurs éléments UI du minuteur n'ont pas été trouvés.");
                return;
            }

            // Gestion des clics sur les boutons de durée
            napButtonsContainer.addEventListener('click', (event) => {
                if (event.target.classList.contains('duration-button')) {
                    const duration = parseInt(event.target.dataset.duration, 10);
                    if (!isNaN(duration)) {
                        napButtonsContainer.querySelectorAll('.duration-button').forEach(btn => btn.classList.remove('active'));
                        event.target.classList.add('active');
                        startNapTimer(duration);
                    }
                }
            });

            // Gestion du clic sur le bouton Annuler
            cancelNapButton.addEventListener('click', cancelNapTimer);

            // Gestion du changement d'état de la checkbox d'alarme
            enableAlarmCheckbox.addEventListener('change', () => {
                isAlarmEnabled = enableAlarmCheckbox.checked;
                console.log(`Alarme musicale ${isAlarmEnabled ? 'activée' : 'désactivée'}.`);
            });

            // Initialiser l'état de l'UI
            resetNapTimerUI();
            // Mettre à jour l'état initial de la variable d'alarme
            isAlarmEnabled = enableAlarmCheckbox.checked;
        }

        function setupEventListeners() {
            // Bouton pour lancer la radio la première fois
            if (startButton) {
                startButton.addEventListener('click', (event) => {
                    event.stopPropagation(); // Empêcher la propagation si nécessaire
                    startRadioFirstTime();
                 });
            } else {
                 console.error("Bouton start-radio-button non trouvé");
            }

            // Bouton pour passer au morceau suivant
            if (nextTrackButton) {
                nextTrackButton.addEventListener('click', () => {
                    if (isLoading) return; // Ne rien faire si déjà en chargement
                    if (!radioHasStarted) {
                        startRadioFirstTime(); // Démarrer si pas encore fait
                    } else {
                        loadNextTrack(); // Charger le morceau suivant
                    }
                });
            } else {
                console.error("Bouton next-track non trouvé");
            }


            // Gestion hors ligne / en ligne
            window.addEventListener('offline', () => {
                console.warn("Connexion perdue.");
                if (nextTrackTimer) clearTimeout(nextTrackTimer);
                const currentIframe = document.getElementById('suno-iframe');
                if (currentIframe) {
                    currentIframe.style.display = 'none'; // Masquer le lecteur
                    // Optionnel: Afficher un message
                    if (!document.getElementById('offline-placeholder')) {
                        const offlineMsg = document.createElement('p');
                        offlineMsg.id = 'offline-placeholder';
                        offlineMsg.className = 'loading-message';
                        offlineMsg.textContent = "Connexion perdue. En attente de reconnexion...";
                        iframeTarget.appendChild(offlineMsg);
                    }
                }
                if(nextTrackButton) nextTrackButton.disabled = true;
                 stopAlarm(); // Arrêter l'alarme si hors ligne
            });

            window.addEventListener('online', () => {
                console.info("Connexion rétablie.");
                if(nextTrackButton) nextTrackButton.disabled = false;
                const offlineMsg = document.getElementById('offline-placeholder');
                if (offlineMsg) offlineMsg.remove(); // Retirer le message hors ligne
                const currentIframe = document.getElementById('suno-iframe');
                if (currentIframe) currentIframe.style.display = 'block'; // Réafficher le lecteur
                // Relancer la lecture si la radio était active
                if (radioHasStarted && !currentTrackId) {
                    console.log("Reprise de la lecture après reconnexion.");
                    loadNextTrack();
                }
            });
        }

        // Initialisation lorsque le DOM est prêt
        document.addEventListener('DOMContentLoaded', () => {
            // Vérifier si la liste des pistes est valide
            if (!sunoTracks || sunoTracks.length === 0) {
                const overlayContent = document.getElementById('initial-play-overlay');
                 const bodyContent = document.body;
                const errorMessage = '<p class="loading-message" style="color: red; padding: 50px;">Erreur critique : La liste des morceaux est vide ou n\'a pas pu être chargée.</p>';
                if(overlayContent) {
                     overlayContent.innerHTML = errorMessage;
                     overlayContent.style.cursor = 'default'; // Pas cliquable
                 } else if (bodyContent) {
                     bodyContent.innerHTML = errorMessage; // Remplacer tout le contenu si l'overlay n'existe pas
                 }
                if (preloader) preloader.classList.add('hidden');
                return; // Arrêter l'exécution
            }

            initializeNapTimerUI(); // Initialiser les éléments du minuteur
            setupEventListeners(); // Configurer les écouteurs d'événements
            if (preloader) preloader.classList.add('hidden'); // Cacher le préchargeur
            if(nextTrackButton) nextTrackButton.disabled = true; // Désactiver "Suivant" initialement
        });

        // --- END OF COMBINED JAVASCRIPT ---
    </script>

    <script>
        // --- Service Worker Registration Script ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('Service Worker enregistré avec la portée :', registration.scope);
                }).catch(err => {
                    console.error('Échec de l\'enregistrement du Service Worker :', err);
                });
            });
        }
        // --- End of Service Worker Registration Script ---
    </script>

</body>
</html>
